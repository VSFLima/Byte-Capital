<?php
// ===================================================================================
// ARQUIVO: telegram.php
// RESPONSABILIDADE: Receber dados da aplica√ß√£o Byte Capital e enviar notifica√ß√µes
// formatadas para o administrador via Telegram.
// ===================================================================================

// --- CABE√áALHOS DE SEGURAN√áA E CONFIGURA√á√ÉO ---
// Permite que a sua aplica√ß√£o (de qualquer dom√≠nio) envie dados para este script.
// Para mais seguran√ßa em produ√ß√£o, pode restringir ao dom√≠nio do seu site.
header("Access-Control-Allow-Origin: *");
header("Access-Control-Allow-Methods: POST, OPTIONS");
header("Access-Control-Allow-Headers: Content-Type");
header("Content-Type: application/json");

// Responde a pedidos OPTIONS (pre-flight requests) que os navegadores enviam.
if ($_SERVER['REQUEST_METHOD'] == 'OPTIONS') {
    exit(0);
}

// --- L√ìGICA PRINCIPAL ---

// Apenas aceita pedidos do tipo POST por seguran√ßa.
if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    http_response_code(405); // Method Not Allowed
    echo json_encode(['status' => 'error', 'message' => 'Apenas o m√©todo POST √© permitido.']);
    exit();
}

// Pega os dados JSON enviados pelo JavaScript.
$json_data = file_get_contents('php://input');
$data = json_decode($json_data, true);

// Valida√ß√£o dos dados recebidos.
if (!isset($data['action']) || !isset($data['details']) || !isset($data['config'])) {
    http_response_code(400); // Bad Request
    echo json_encode(['status' => 'error', 'message' => 'Dados em falta no pedido.']);
    exit();
}

// Extrai os dados para vari√°veis mais f√°ceis de usar.
$action = $data['action'];
$details = $data['details'];
$config = $data['config'];

$botToken = $config['telegramToken'];
$chatId = $config['telegramChatId'];

// Vari√°vel que ir√° guardar a nossa mensagem final.
$mensagem = "";

// --- REA√á√ÉO A CADA TIPO DE A√á√ÉO ---

// Usamos um switch para reagir de forma diferente a cada 'action'.
switch ($action) {
    case 'novo_deposito':
        $nome = htmlspecialchars($details['nome']);
        $valor = htmlspecialchars($details['valor']);
        $mensagem = "üîî Novo Pedido de Dep√≥sito na Byte Capital!\n\n" .
                    "üë§ Utilizador: " . $nome . "\n" .
                    "üí∞ Valor: " . $valor . "\n\n" .
                    "‚û°Ô∏è A√ß√£o Necess√°ria: Aceda ao painel de administra√ß√£o para aprovar o dep√≥sito e creditar o saldo.";
        break;

    case 'novo_saque':
        $nome = htmlspecialchars($details['nome']);
        $valor = htmlspecialchars($details['valor']);
        $status = htmlspecialchars($details['status']);
        $mensagem = "üîî Novo Pedido de Saque na Byte Capital!\n\n" .
                    "üë§ Utilizador: " . $nome . "\n" .
                    "üí∞ Valor: " . $valor . "\n" .
                    "üö¶ Estado: " . ($status == 'em_analise' ? 'EM AN√ÅLISE (CPF diferente)' : 'Pendente') . "\n\n" .
                    "‚û°Ô∏è A√ß√£o Necess√°ria: Aceda ao painel para processar o pagamento.";
        break;

    case 'novo_usuario':
        $nome = htmlspecialchars($details['nome']);
        $email = htmlspecialchars($details['email']);
        $mensagem = "üéâ Novo Registo na Byte Capital!\n\n" .
                    "üë§ Nome: " . $nome . "\n" .
                    "üì© Email: " . $email;
        break;
        
    case 'suporte':
        $nome = htmlspecialchars($details['nome']);
        $mensagemTexto = htmlspecialchars($details['mensagem']);
        $mensagem = "üí¨ Nova Mensagem de Suporte na Byte Capital!\n\n" .
                    "üë§ Utilizador: " . $nome . "\n" .
                    "üìù Mensagem: " . $mensagemTexto;
        break;

    default:
        // Se a a√ß√£o n√£o for reconhecida, n√£o fazemos nada.
        echo json_encode(['status' => 'success', 'message' => 'A√ß√£o n√£o requer notifica√ß√£o.']);
        exit();
}

// --- FUN√á√ÉO DE ENVIO PARA O TELEGRAM ---

/**
 * Envia a mensagem formatada para a API do Telegram.
 * @param string $token - O token do bot.
 * @param string $chat_id - O ID da conversa.
 * @param string $message - A mensagem a ser enviada.
 * @return bool - True se a mensagem foi enviada, false caso contr√°rio.
 */
function enviarNotificacaoTelegram($token, $chat_id, $message) {
    if (empty($token) || empty($chat_id)) {
        return false;
    }
    $url = "https://api.telegram.org/bot" . $token . "/sendMessage?chat_id=" . $chat_id . "&text=" . urlencode($message);
    
    // Usar cURL para um m√©todo mais robusto (se dispon√≠vel na sua hospedagem)
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $response = curl_exec($ch);
    curl_close($ch);
    
    return $response !== false;
}

// Envia a notifica√ß√£o e retorna uma resposta para o JavaScript.
if (enviarNotificacaoTelegram($botToken, $chatId, $mensagem)) {
    echo json_encode(['status' => 'success', 'message' => 'Notifica√ß√£o enviada.']);
} else {
    http_response_code(500); // Internal Server Error
    echo json_encode(['status' => 'error', 'message' => 'Falha ao enviar notifica√ß√£o. Verifique o Token e o Chat ID.']);
}

?>

<?php
// ===================================================================================
// ARQUIVO: telegram.php
// RESPONSABILIDADE: Receber dados da aplica√ß√£o Byte Capital e enviar notifica√ß√µes
// formatadas para o administrador via Telegram.
// ===================================================================================

// --- CABE√áALHOS DE SEGURAN√áA E CONFIGURA√á√ÉO ---
// Permite que a sua aplica√ß√£o (de qualquer dom√≠nio) envie dados para este script.
// Para mais seguran√ßa em produ√ß√£o, pode restringir ao dom√≠nio do seu site.
header("Access-Control-Allow-Origin: *");
header("Access-Control-Allow-Methods: POST, OPTIONS");
header("Access-Control-Allow-Headers: Content-Type");
header("Content-Type: application/json");

// Responde a pedidos OPTIONS (pre-flight requests) que os navegadores enviam.
if ($_SERVER['REQUEST_METHOD'] == 'OPTIONS') {
    exit(0);
}

// --- L√ìGICA PRINCIPAL ---

// Apenas aceita pedidos do tipo POST por seguran√ßa.
if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    http_response_code(405); // Method Not Allowed
    echo json_encode(['status' => 'error', 'message' => 'Apenas o m√©todo POST √© permitido.']);
    exit();
}

// Pega os dados JSON enviados pelo JavaScript.
$json_data = file_get_contents('php://input');
$data = json_decode($json_data, true);

// Valida√ß√£o dos dados recebidos.
if (!isset($data['action']) || !isset($data['details']) || !isset($data['config'])) {
    http_response_code(400); // Bad Request
    echo json_encode(['status' => 'error', 'message' => 'Dados em falta no pedido.']);
    exit();
}

// Extrai os dados para vari√°veis mais f√°ceis de usar.
$action = $data['action'];
$details = $data['details'];
$config = $data['config'];

$botToken = $config['telegramToken'];
$chatId = $config['telegramChatId'];

// Vari√°vel que ir√° guardar a nossa mensagem final.
$mensagem = "";

// --- REA√á√ÉO A CADA TIPO DE A√á√ÉO ---

// Usamos um switch para reagir de forma diferente a cada 'action'.
switch ($action) {
    case 'novo_deposito':
        $nome = htmlspecialchars($details['nome']);
        $valor = htmlspecialchars($details['valor']);
        $mensagem = "üîî Novo Pedido de Dep√≥sito na Byte Capital!\n\n" .
                    "üë§ Utilizador: " . $nome . "\n" .
                    "üí∞ Valor: " . $valor . "\n\n" .
                    "‚û°Ô∏è A√ß√£o Necess√°ria: Aceda ao painel de administra√ß√£o para aprovar o dep√≥sito e creditar o saldo.";
        break;

    case 'novo_saque':
        $nome = htmlspecialchars($details['nome']);
        $valor = htmlspecialchars($details['valor']);
        $status = htmlspecialchars($details['status']);
        $mensagem = "üîî Novo Pedido de Saque na Byte Capital!\n\n" .
                    "üë§ Utilizador: " . $nome . "\n" .
                    "üí∞ Valor: " . $valor . "\n" .
                    "üö¶ Estado: " . ($status == 'em_analise' ? 'EM AN√ÅLISE (CPF diferente)' : 'Pendente') . "\n\n" .
                    "‚û°Ô∏è A√ß√£o Necess√°ria: Aceda ao painel para processar o pagamento.";
        break;

    case 'novo_usuario':
        $nome = htmlspecialchars($details['nome']);
        $email = htmlspecialchars($details['email']);
        $mensagem = "üéâ Novo Registo na Byte Capital!\n\n" .
                    "üë§ Nome: " . $nome . "\n" .
                    "üì© Email: " . $email;
        break;
        
    case 'suporte':
        $nome = htmlspecialchars($details['nome']);
        $mensagemTexto = htmlspecialchars($details['mensagem']);
        $mensagem = "üí¨ Nova Mensagem de Suporte na Byte Capital!\n\n" .
                    "üë§ Utilizador: " . $nome . "\n" .
                    "üìù Mensagem: " . $mensagemTexto;
        break;

    default:
        // Se a a√ß√£o n√£o for reconhecida, n√£o fazemos nada.
        echo json_encode(['status' => 'success', 'message' => 'A√ß√£o n√£o requer notifica√ß√£o.']);
        exit();
}

// --- FUN√á√ÉO DE ENVIO PARA O TELEGRAM ---

/**
 * Envia a mensagem formatada para a API do Telegram.
 * @param string $token - O token do bot.
 * @param string $chat_id - O ID da conversa.
 * @param string $message - A mensagem a ser enviada.
 * @return bool - True se a mensagem foi enviada, false caso contr√°rio.
 */
function enviarNotificacaoTelegram($token, $chat_id, $message) {
    if (empty($token) || empty($chat_id)) {
        return false;
    }
    $url = "https://api.telegram.org/bot" . $token . "/sendMessage?chat_id=" . $chat_id . "&text=" . urlencode($message);
    
    // Usar cURL para um m√©todo mais robusto (se dispon√≠vel na sua hospedagem)
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    $response = curl_exec($ch);
    curl_close($ch);
    
    return $response !== false;
}

// Envia a notifica√ß√£o e retorna uma resposta para o JavaScript.
if (enviarNotificacaoTelegram($botToken, $chatId, $mensagem)) {
    echo json_encode(['status' => 'success', 'message' => 'Notifica√ß√£o enviada.']);
} else {
    http_response_code(500); // Internal Server Error
    echo json_encode(['status' => 'error', 'message' => 'Falha ao enviar notifica√ß√£o. Verifique o Token e o Chat ID.']);
}

?>

